---
title: "Ploteando No Detectados (ND)"
subtitle: "Presentation by Ing. A.Otiniano"
author: "Ing. A.Otiniano"
institute: "UNI"
output: 
  beamer_presentation:
    theme: "CambridgeUS"
    #colortheme: "dolphin"
    fonttheme: "professionalfonts"
    toc: true # Table of contents
    slide_level: 2  # Enable subsections (optional)
    keep_tex: false # keeps the .tex generated (also images)
    latex_engine: xelatex # Latex engine
    incremental: true
    includes:
      in_header: mystyle.tex
date: "`r Sys.Date()`"
header-includes: # format latex (you can add from latex)
- \logo{\includegraphics[width= 2cm]{figura/logo.png}}
  \AtBeginDocument{\setbeamertemplate{navigation symbols}[horizontal]}  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
suppressPackageStartupMessages(library(EnvStats))
```

# Objetivos 

* Conocer y usar los  **boxplots**.

* Conocer y usar los **X-Y scatterplots**.

* Interpretar y usar las **Probability Density Functions (pdf)**.

* Interpretar y usar las **Cumulative Distribution Functions (cdf)**.

* Conocer los **plots de probabilidad**.

# Boxplots

## Boxplots estructura

\begincols
  \begincol{.30\textwidth}

1. Centrado

2. Variabilidad (*IQR*)

3. *Asimetría*

4. Outliers - Faroutliers

  \endcol
\begincol{.70\textwidth}

```{r, warning=FALSE, message=FALSE}
# Load the necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)

# Generate some example data
set.seed(123)  # for reproducibility
information <- data.frame(
  group = rep(c("A", "B"), each = 100),
  value = c(rlnorm(100, meanlog = 0, sdlog = 1), rnorm(100, mean = 7))
)

# Calculate summary statistics for annotations
summary_data <- information %>%
  group_by(group) %>%
  summarise(
    Q1 = quantile(value, 0.25),
    Median = quantile(value, 0.50),
    Q3 = quantile(value, 0.75),
    Max = max(value),
    Min = min(value)
  ) %>%
  gather(key = "stat", value = "value", -group)

# Calculate mean for each group
mean_data <- information %>%
  group_by(group) %>%
  summarise(mean_value = mean(value))

# Create the boxplot
p <- ggplot(information, aes(x = group, y = value)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16, outlier.size = 2) +
  geom_point(data = mean_data, aes(y = mean_value), color = "blue", size = 3) +
  labs(title = "Boxplot with Quantiles, IQR, Max, Min, Outliers, and Mean",
       x = "Group",
       y = "Value")

# Add annotations for quantiles, IQR, max, and min
p + geom_text(data = summary_data, aes(label = stat, y = value),
              position = position_dodge(width = 0.75),
              size = 3, hjust = -0.5, vjust = -0.5)
```

  \endcol
\endcols

## Boxplot con ND

```r
cboxplot(mina.Zn,mina.cen.Zn,xgroup=Subcuenca,LOG=TRUE)
```

\begincols
  \begincol{.40\textwidth}

a) Buena forma de ilustrar diferencias entre grupos.


b) Sobre el máximo Ld, es identico a un boxplot que podría haber dibujado para la misma data sin límite de detección.


c) No estimaciones debajo del **maxLd** son mostradas por defecto.

  \endcol
\begincol{.60\textwidth}

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
db_puno <- readxl::read_xlsx(path = "Geodatabase/BD_GA47D_PUNO CONSOLIDADO_FINAL.xlsx")
elements <- c("Fe","Zn")

for (element in elements) {
  col_dis <- paste0(element, "_dis")
  col_valdis <- paste0(element, "_valdis")
  col_valdis_cen <- paste0(element, "_valdis_cen")
  
  db_puno[[col_valdis]] <- as.numeric(str_remove(db_puno[[col_dis]], pattern = "<"))
  db_puno[[col_valdis_cen]] <- ifelse(str_detect(db_puno[[col_dis]], pattern = "<"), TRUE, FALSE)
}

NADA2::cboxplot(x1 = db_puno$Zn_valdis, db_puno$Zn_valdis_cen, 
                xgroup = db_puno$Subcuenca, LOG = TRUE)
```

  \endcol
\endcols

## Boxplot con ND2

\begincols
  \begincol{.40\textwidth}
  
1. Porción debajo del max Ld es estimado con ROS y mostrada con `shown=TRUE`.

2. Estimados son sombreados con gris para indicar incertidumbre.

3. No usar `mimax=TRUE` da por defecto boxplot con outliers.

  \endcol
\begincol{.60\textwidth}

```{r, warning=FALSE, message=FALSE}
NADA2::cboxplot(x1 = db_puno$Zn_valdis, db_puno$Zn_valdis_cen, 
                xgroup = db_puno$Temporada, LOG = TRUE, minmax = TRUE, show = TRUE)
```

  \endcol
\endcols

# X-Y Scatterplots

## X-Y Scatterplots with ND

```r
cenxyplot(Zn, Zn_cen, Fe, Fe_cen, log="xy")
```
\begincols
  \begincol{.30\textwidth}
1. Puntos detectados son ploteados individualmente.

2. No detectados son mostrado como un intervalo (líneas punteadas).

3. El eje x e y están en escala logarítmica.

  \endcol
\begincol{.70\textwidth}

```{r xyscatter, out.width='80%', fig.align='center', fig.cap='X-Y Scatterplot LogscaleXY'}
NADA::cenxyplot(x = db_puno$Zn_valdis, xcen = db_puno$Zn_valdis_cen,
                y = db_puno$Fe_valdis, ycen = db_puno$Fe_valdis_cen,
                xlab ="Concentracion de Zn (mg/l)", ylab="Concentracion de Fe(mg/l)",
                log = "xy")
```

  \endcol
\endcols

## X-Y Scatterplots with ATS line

\begincols
  \begincol{.30\textwidth}

1. El formato es: `ATS(y,ycen, x, xcen, LOG=FALSE)`

2. Existen algunos no detectados como lineas punteadas en la base.


  \endcol
\begincol{.70\textwidth}

```{r xyscatterATS, out.width='80%', fig.align='center', warning=FALSE, message=FALSE, comment=FALSE, results='hide'}
NADA2::ATS(y.var = db_puno$Zn_valdis, y.cen = db_puno$Zn_valdis_cen,
           x.var = db_puno$Fe_valdis, x.cen = db_puno$Fe_valdis_cen,
           LOG = TRUE,
           xlabel = "Concentracion de Fe (mg/l)", ylabel ="Concentracion de Zn (mg/l)")
```
  \endcol
\endcols

# Función de Probabilidad de Densidad (pdf)

## PDF
\begincols
  \begincol{.30\textwidth}

1. La  familiar "curva de campana o Gausiana" de la distribución normal.

  \endcol
\begincol{.70\textwidth}

```{r pdf1, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_01.png")
```
  \endcol
\endcols

## PDF
\begincols
  \begincol{.30\textwidth}

1. Una forma más realista para la data con no detectados son distribuciones asimétricas.

2. Dos distribuciones simétricas comunes son Lognormal y Gamma.

  \endcol
\begincol{.70\textwidth}

```{r pdf2, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_02.png")
```
  \endcol
\endcols

## PDF  para datos censurados

Histograma: una barra no es dibujada para datos censurados. No deectados no son mostrados. No existen valores para el 14% de data inferior, solo conocemos que estos son <2.

\begincols
  \begincol{.30\textwidth}

1. El ajuste de la distribución debería tener un % dabajo de 2 similar al % en el set de datos.

  \endcol
\begincol{.70\textwidth}

```{r pdf3, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_03.png")
```
  \endcol
\endcols


# Función de Probabilidad de Densidad Acumulada (cdf)

## CDF: Cummulative Distribution Functions


\begincols
  \begincol{.50\textwidth}

```{r cdf1, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_04_1.png")
```
  \endcol
\begincol{.50\textwidth}

```{r cdf2, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_04_2.png")
```
  \endcol
\endcols


## CDF: Cummulative Distribution Functions


\begincols
  \begincol{0.30\textwidth}

No NDs para comenzar, n = 10

3.33
2.19
1.81
1.33
1.11
0.91
0.91
0.81
0.77
$0.38$

Los **saltos** son 1/n


  \endcol
\begincol{0.70\textwidth}

```{r cdf3, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_05.png")
```
  \endcol
\endcols

## CDF para datos censurados

```{r cdf4, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_06.png")
```


## Mejor Ajuste cdf para datos censurados

\begincols
  \begincol{0.30\textwidth}

1. Data es mostrada como una step function. Caja color plomo esta debajo del menor Ld.

2. Gamma parece el mejor ajuste, 2nd lognormal.

3. Nota: solo la distribución normal estima debajo de 0.

  \endcol
\begincol{0.70\textwidth}

```{r cdf5, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_07.png")
```
  \endcol
\endcols

# Plots de Probabilidad (or Q-Q plots)

## Q-Q plots para data con NDs

\begincols
  \begincol{0.40\textwidth}

1. Plots de probabilidad <= valores de data para observaciones detectdas en el eje X.

2. No detectados no son ploteados, pero espacios a la izquierda de las observaciones detectadas en percentiles es correcto.

3. Una línea continua representa la disribución tales como la normal, lognormal o gamma.


  \endcol
\begincol{0.60\textwidth}

4. PPCC mide el ajuste. Max PPCC=1. Escoger la distribución con mayor PPCC.

```{r qq1, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_08.png")
```
  \endcol
\endcols

## Q-Q plots para data con No Detectados

\begincols
  \begincol{0.50\textwidth}

1. En vez de las probabilidades no lineales <= valor dato, software usualmente plotea una linea escalar. Una es quantiles normales.

2. Quantiles normales son quantiles de la distribución normal con media=0 y sd=1.

3. No detectados influencian en los cuantiles de los detectados.Aquí los menores valores detectados son justo menor que +1, cual esta a 78% del dataset.


  \endcol
\begincol{.50\textwidth}

4. Aquíe el 78% del área de datos < menor límite de detección. Múltiplos Ld pueden ser incorporados.

```{r qq2, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_09.png")
```
  \endcol
\endcols


## Q-Q plots para ajustar distribución de datos con ND

\begincols
  \begincol{0.40\textwidth}

1. Esto es ploteado correctamente.**30%** de no detectados no son mostrado como puntos, pero el espacio es reservado en la parte inferior.

2. Encontraremos la rutina para hacer esto en "Survivial Analysis" o "Censored data" de los software estadísticos.

3. El comando **qqPlotCensored()** en el paquete *EnvStats* es uno de estos.


  \endcol
\begincol{0.60\textwidth}


```{r qq3, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_08.png")
```
  \endcol
\endcols

## Q-Q plots data con NDs es eliminada incorrectamente

\begincols
  \begincol{0.40\textwidth}

1. No ploteada correctamente. Usar Q-Q plots estándar que no están diseñado para data con no detectados.

2. Eliminar no detectados, así que **todos los percentiles son empujados al inferior** (*desviados hacia la izquierda*).

3. Desajustes de la distribución comparada con la verdadera forma de la data.

  \endcol
\begincol{0.60\textwidth}


```{r qq4, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_10.png")
```
  \endcol
\endcols

## Q-Q plots con 1/2 Ld subtituidos por NDs

\begincols
  \begincol{0.40\textwidth}

1. Substituir los valores por una linea recta en la parte inferior.

2. Distorsionar la distribución en su parte baja comparada con al verdadera forma de la data.

3. Tendencia a escoger la distribución incorrecta; malos estimados para los percentiles en la parte baja.

  \endcol
\begincol{0.60\textwidth}


```{r qq5, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_11.png")
```
  \endcol
\endcols


## Q-Q plots de posible ajuste distribución para data con NDs

\begincols
  \begincol{0.40\textwidth}

1. Distribución con una data cerrada a una línea recta, o con el más alto BIC (Bayesian Information Criterion) o Shapiro-Francia (coeficiente de correlación), es el mejor ajuste.

2. Aquí la distribución normal es el mejor ajuste comparada con las tres otrs distribuciones.


  \endcol
\begincol{0.60\textwidth}


```{r qq6, out.width='100%', fig.align='center'}
knitr::include_graphics(path="Graficos/AEDND_03_12.png")
```
  \endcol
\endcols

# Ajustando Distribuciones en R

## Ajuste de Distribución

```{r, eval=TRUE, include=TRUE, echo=TRUE, warning=FALSE, comment=FALSE, message=FALSE}
bd1 <- read.csv(file="../ParteIA/Code/Ejemplos/Example1.txt", header = TRUE, sep = " ")
attach(bd1)
NADA::censummary(Arsenic, NDisTRUE)
# 21 obs. Pequeño para decidir que distribución usar!
```

## Calcular PPCC o BIC para mejor distribución.


```{r, eval=FALSE,echo=TRUE}
library(EnvStats)
gofTestCensored(Arsenic, NDisTRUE, dist="gamma", test="ppcc")
gofTestCensored(Arsenic, NDisTRUE, dist="lnorm", test="ppcc")
gofTestCensored(Arsenic, NDisTRUE, dist="norm", test="ppcc")
```

```{r,echo=TRUE}
# gamma - PPCC = r = 0.969  # Mejor Ajuste
# lnorm - PPCC = r = 0.966
# norm  - PPCC = r = 1.968
```


1. Mejor: Maximizar el PPCC, minimizar el BIC para obtener la mejor distribución.

2. Mayor PPCC es **0.969** es la distribución gamma. Casi el mismo valor que la distribución normal, podría ser usada la normal? **No! (Recordar como esto esta fuera del plot CDF?)**.


## Si la distribución normal es escogida (No!)

```{r, eval=TRUE,echo=TRUE, fig.align='center', out.width='70%'}
qqPlotCensored(Arsenic,NDisTRUE,dist="norm",add.line=TRUE)
abline(h=0, col="red")
abline(v=-0.70, col="red", lty=3)
```

## Si la distribución normal es escogida (No!) 2

1. Distribución normal produce aproximadamente 15% de números negativos.

2. Inaceptable! Rechazar incluso si tiene mayor PPCC. Las estimaciones de la media y UCL serán incorrectas.

## Usar el siguiente mayor PPCC: distribución gamma

```{r, eval=TRUE,echo=TRUE, out.width='50%', fig.align='center'}
qqPlotCensored(Arsenic,NDisTRUE,dist="gamma",add.line=TRUE,
               estimate.params = TRUE)
```

1. La distribución gamm tiene el *mayor PPCC = 0.969*

2. BIC de las 3 distribuciones usar el paquete *fitdist()* escoger el menor es mejor. *gamma = 43.9, lognormal = 44.6 & normal = 50.6*.

## Sumario

1. Los mejores métodos son los que usan probabilidades y cuantiles.

2. Esto es debido a que no detectados contienen en probabilidades de ser <Ld.

3. Boxplots, plots de probabilidad, PDFs y CDFs todos proveen información valiosa.

4. Scatterplots puede ser usados para plotear no detectados como lineas punteadas o barras de intervalos en vez de como puntos.








